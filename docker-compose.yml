version: "3.9"

networks:
  media-net:
    name: media-net

services:
  # --- ğŸ›¡ï¸ Infrastructure (ê´€ì œ ë° ì¸í”„ë¼) ---
  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    restart: unless-stopped
    env_file:
      - .env
    # í˜¸ìŠ¤íŠ¸ì˜ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤(enp3s0, tailscale0 ë“±)ì— ì§ì ‘ ì ‘ê·¼í•˜ê¸° ìœ„í•´ í•„ìš”
    network_mode: host
    security_opt:
      - label=disable
      - unmask=ALL
    cap_add:
      - SYS_ADMIN
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Asia/Ho_Chi_Minh # í˜¸ì¹˜ë¯¼ ì‹œê°„ëŒ€ (ì‹œê³„ ìœ„ì ¯ìš©)
      - HOMEPAGE_ALLOWED_HOSTS=*
      # Podman ì‚¬ìš© ì‹œ Docker API ì‘ë‹µì„ ìœ„í•´ í•„ìš”í•œ ê²½ìš° ì¶”ê°€
      #- DOCKER_RENAME_CONTAINERS=true
    volumes:
      - /home/crong/git/heritage/homepage/config:/app/config:Z
      # Podman User Socket: Homepage ë‚´ë¶€ì˜ Docker ìœ„ì ¯ì´ ì»¨í…Œì´ë„ˆ ìƒíƒœë¥¼ ì½ì„ ìˆ˜ ìˆê²Œ í•¨
      - /run/user/1000/podman/podman.sock:/var/run/docker.sock:ro,z
      # í˜¸ìŠ¤íŠ¸ì˜ ë£¨íŠ¸(/)ë¥¼ ì»¨í…Œì´ë„ˆì˜ /hostë¡œ ë§¤í•‘ (í†µê³„ ì½ê¸°ìš©)
      - /:/host:ro,z
      # ì‹¤ì œ ë°ì´í„° HDD ë§¤í•‘
      - /mnt/data1:/host/mnt/data1:ro,z
      - /mnt/data2:/host/mnt/data2:ro,z
      # ì•„ë˜ ê²½ë¡œë¥¼ ì¶”ê°€í•˜ì—¬ systeminformation ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í˜¸ìŠ¤íŠ¸ ì •ë³´ë¥¼ ì½ê²Œ í•©ë‹ˆë‹¤.
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro

  prowlarr:
    # ê³µì‹ GitHub ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì´ë¯¸ì§€ ì‚¬ìš© (ê°€ì¥ ë¹ ë¥´ê³  ì •í™•í•œ ì—…ë°ì´íŠ¸)
    image: ghcr.io/hotio/prowlarr
    container_name: prowlarr
    restart: unless-stopped
    ports:
      - "9696:9696"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Asia/Ho_Chi_Minh
      # .NET ì„±ëŠ¥ ìµœì í™” (N100 8G í™˜ê²½ì—ì„œ ë¶ˆí•„ìš”í•œ ë””ë²„ê·¸ ë¡œê·¸ ë° ì˜¤ë²„í—¤ë“œ ê°ì†Œ)
      - COMPlus_EnableDiagnostics=0
    volumes:
      # ì„¤ì • ë° SQLite DB ì €ì¥ì†Œ
      - /home/crong/git/heritage/prowlarr:/config:Z
      # (ì„ íƒ ì‚¬í•­) ëŒ€ê·œëª¨ ì¸ë±ì‹± ì‹œ ë¡œê·¸ íŒŒì¼ì´ N100 NASì˜ ì‹œìŠ¤í…œ ë””ìŠ¤í¬ë¥¼ ì±„ìš°ì§€ ì•Šë„ë¡ ë³„ë„ ê´€ë¦¬ ê¶Œì¥
      - /home/crong/logs/heritage/prowlarr:/config/logs:Z
    # N100 8G ë©”ëª¨ë¦¬ íš¨ìœ¨ì„ ìœ„í•œ ê°€ì´ë“œë¼ì¸
    mem_limit: 1g
    networks:
      - media-net

  # --- ğŸ“¥ Acquisition Engines (ìˆ˜ì§‘ ì—”ì§„ ì—…ê·¸ë ˆì´ë“œ) ---
  torrent: # ì„œë¹„ìŠ¤ ëª…ì¹­ ë‹¨ì¼í™”
    image: docker.io/crazymax/rtorrent-rutorrent # í˜¸í™˜ì„±ì´ ê²€ì¦ëœ hotio ì´ë¯¸ì§€ë¡œ êµì²´
    container_name: torrent
    # 1. ê³ ë¶€í•˜ ì‹œ ì†Œì¼“ ë¶€ì¡± ë°©ì§€ (DevOps í•„ìˆ˜ ì„¤ì •)
    ulimits:
      nproc: 65535
      nofile:
        soft: 65535
        hard: 65535
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Asia/Ho_Chi_Minh
      - RT_INC_PORT=50000 # ì¸ë°”ìš´ë“œ í¬íŠ¸ ê³ ì •
    ports:
      - "8080:8080" # ruTorrent Web UI
      - "8000:8000" # XMLRPC (Prowlarr, Whisparr ì—°ë™ í•„ìˆ˜ í¬íŠ¸)
      - "50000:50000" # Peer í†µì‹ ìš© (TCP)
      - "6881:6881/udp" # DHTìš©
    volumes:
      - /home/crong/git/heritage/torrent:/data:Z
      - /mnt/data1/torrent:/downloads:z
      - /mnt/data2/torrent:/completed_hdd2:z
    # 2. Podman í™˜ê²½ì—ì„œì˜ ì•ˆì •ì„±ì„ ìœ„í•œ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì‹œê°„
    stop_grace_period: 30s
    networks:
      - media-net
    restart: always

  jdownloader:
    image: docker.io/jlesage/jdownloader-2
    container_name: jdownloader
    restart: unless-stopped
    ports:
      - "5800:5800"
      - "5900:5900"
    environment:
      # 1. ê¶Œí•œ ì„¤ì • (jlesage ì´ë¯¸ì§€ëŠ” USER_ID/GROUP_ID í˜•ì‹ì„ ê¶Œì¥)
      - USER_ID=1000
      - GROUP_ID=1000
      - TZ=Asia/Ho_Chi_Minh

      # 2. UI ë° í™˜ê²½ ìµœì í™”
      - DARK_MODE=1 # ì•¼ê°„ ì‘ì—… ì‹œ ëˆˆ ë³´í˜¸ë¥¼ ìœ„í•œ ë‹¤í¬ëª¨ë“œ í™œì„±í™”
      - KEEP_APP_RUNNING=1 # ì•±ì´ ë¹„ì •ìƒ ì¢…ë£Œ ì‹œ ìë™ìœ¼ë¡œ ë‹¤ì‹œ ì‹¤í–‰
      - DISPLAY_WIDTH=1280 # Web UI ê¸°ë³¸ í•´ìƒë„ ì„¤ì •
      - DISPLAY_HEIGHT=720

      # 3. Java ëŸ°íƒ€ì„ ìµœì í™” (N100 8G í™˜ê²½ì— ë§ì¶˜ GC ë° ë©”ëª¨ë¦¬ ì„¤ì • ìœ ì§€)
      - JAVA_OPTIONS=-Xmx512m -Xms256m -XX:+UseSerialGC -Djava.awt.headless=false

      # 4. MyJDownloader ì—°ë™ (ì„ íƒ ì‚¬í•­: ì›ê²© ì œì–´ë¥¼ ìœ„í•´ ê¶Œì¥)
      #- MYJDOWNLOADER_EMAIL=ksymailing@gmail.com
      #- MYJDOWNLOADER_PASSWORD=
    volumes:
      - /home/crong/git/heritage/jdownloader-2:/config:Z # Fedora SELinux ëŒ€ì‘
      - /mnt/data1/torrent/jd2_downloads:/output:z # ë‹¤ìš´ë¡œë“œ ì €ì¥ì†Œ (sda1)
    # N100 ë©”ëª¨ë¦¬ ë³´í˜¸ë¥¼ ìœ„í•œ ì œí•œ
    mem_limit: 1g
    networks:
      - media-net

  # --- ğŸ›ï¸ Curatorial Tools (ê¸°ë¡ ë° ë¶„ë¥˜) ---
  whisparr:
    # ê³µì‹ GitHub ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì´ë¯¸ì§€ ì‚¬ìš© (Hotioì—ì„œ ê³µì‹ìœ¼ë¡œ ì „í™˜)
    image: ghcr.io/hotio/whisparr:v3
    container_name: whisparr
    restart: unless-stopped
    ports:
      - "6969:6969"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Asia/Ho_Chi_Minh
      - UMASK=002 # íŒŒì¼ ê¶Œí•œ ë¬´ê²°ì„±ì„ ìœ„í•œ í‘œì¤€ ì„¤ì •
      - COMPlus_EnableDiagnostics=0 # .NET ì§„ë‹¨ ë¹„í™œì„±í™” (ë¦¬ì†ŒìŠ¤ ì ˆì•½)
    volumes:
      - /home/crong/git/heritage/whisparr:/config:Z
      # ë°ì´í„° ë³¼ë¥¨ (N100 I/O ë¶€í•˜ ê´€ë¦¬ë¥¼ ìœ„í•´ í•„ìš” ì‹œ ì „ìš© ë§ˆìš´íŠ¸ ê³ ë ¤)
      - /mnt/data1/torrent:/data1:z
      - /mnt/data2/torrent:/data2:z
    mem_limit: 1g # N100 8G í™˜ê²½ì„ ê³ ë ¤í•œ ë©”ëª¨ë¦¬ ìº¡
    networks:
      - media-net

  stash:
    image: docker.io/stashapp/stash:latest
    container_name: stash
    restart: unless-stopped
    ports:
      - "9999:9999"
    # 1. í•˜ë“œì›¨ì–´ ê°€ì† (N100ì˜ Intel QuickSync í™œìš©)
    devices:
      - /dev/dri:/dev/dri
    environment:
      - STASH_CONFIG_FILE=/config/config.yml
      # 2. ì„±ëŠ¥ ë° ê¶Œí•œ ìµœì í™” ë³€ìˆ˜
      - PUID=1000
      - PGID=1000
      - TZ=Asia/Ho_Chi_Minh
      # í•˜ë“œì›¨ì–´ ê°€ì†ì„ ìœ„í•œ FFmpeg í™˜ê²½ë³€ìˆ˜ (ì´ë¯¸ì§€ ë‚´ë¶€ ê¸°ë³¸ê°’ì´ë‚˜ ëª…ì‹œ ê¶Œì¥)
      - STASH_FFMPEG_PATH=/usr/bin/ffmpeg
    volumes:
      - /home/crong/git/heritage/stash:/config:Z
      # 3. ë°ì´í„° êµ¬ì¡° ìµœì í™” (ì‚¬ìš©ì ì •ì˜ ê²½ë¡œ ìœ ì§€)
      - /mnt/data1/torrent:/data1:z
      - /mnt/data2/torrent:/data2:Z
      # 4. ìºì‹œ ë° ìƒì„± íŒŒì¼ ì „ìš© ë³¼ë¥¨ (ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•´ ê¶Œì¥)
      - /home/crong/git/heritage/stash/cache:/cache:Z
      - /home/crong/git/heritage/stash/generated:/generated:Z
    # 5. ë¯¸ë””ì–´ ì¸ë±ì‹± ì‹œ I/O ë¶€í•˜ ê´€ë¦¬ë¥¼ ìœ„í•œ ë¦¬ì†ŒìŠ¤ ì œí•œ (N100 8G ë°°ë ¤)
    mem_limit: 2g
    networks:
      - media-net

  # --- ğŸ­ Digital Theater (ì „ì‹œ ë° ìŠ¤íŠ¸ë¦¬ë°) ---
  jellyfin:
    image: docker.io/jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    # 1. í˜¸ìŠ¤íŠ¸ì˜ UID/GID(1000)ë¥¼ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œë„ ê·¸ëŒ€ë¡œ ìœ ì§€
    # userns: "keep-id"
    # 1. í•˜ë“œì›¨ì–´ ê°€ì†ì„ ìœ„í•œ ê·¸ë£¹ ê¶Œí•œ (Fedoraì˜ render ê·¸ë£¹ GID í™•ì¸ í•„ìš”)
    group_add:
      - "keep-groups"
    ports:
      - "8096:8096"
    devices:
      # 2. Intel QSV í•˜ë“œì›¨ì–´ ê°€ì† ë§¤í•‘ (N100 í•„ìˆ˜ ì„¤ì •)
      - /dev/dri:/dev/dri
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Asia/Ho_Chi_Minh
      # 3. ìë™ ê²€ìƒ‰ ë° ë„¤íŠ¸ì›Œí¬ ì‹ë³„ì„ ìœ„í•œ ì„œë²„ URL ëª…ì‹œ
      - JELLYFIN_PublishedServerUrl=http://192.168.1.108:8096
    volumes:
      - /home/crong/git/heritage/jellyfin/config:/config:Z
      - /home/crong/git/heritage/jellyfin/cache:/cache:Z # íŠ¸ëœìŠ¤ì½”ë”© ë¶€í•˜ ë¶„ì‚°ì„ ìœ„í•œ ë³„ë„ ìºì‹œ
      - /mnt/data1/torrent:/data1:ro,z # ì½ê¸° ì „ìš©ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì—°ê²°
      - /mnt/data2/torrent:/data2:ro,z
    # 4. N100 8G ë©”ëª¨ë¦¬ íš¨ìœ¨ì„ ìœ„í•œ ì œí•œ
    mem_limit: 2g
    networks:
      - media-net
